services:
  # Nginx 리버스 프록시 및 정적 파일 서버
  nginx:
    image: nginx:alpine
    platform: linux/arm64
    container_name: cookduck-nginx
    ports:
      - "${NGINX_PORT:-81}:80"
    volumes:
      - ./backend-server/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./backend-server/nginx/html:/var/www/html:ro
    depends_on:
      - fastapi
      - fastapi-gateapi
      - spring
      - vision
    restart: unless-stopped
    networks:
      - cookduck-network

  # FastAPI 메인 서버 (레시피 추천 API)
  fastapi:
    build:
      context: ./backend-server/fastapi
      dockerfile: Dockerfile
    platform: linux/arm64
    container_name: cookduck-fastapi
    ports:
      - "${FASTAPI_PORT:-8004}:8000"
      - "${FASTAPI_SSH_PORT:-2202}:22"
    volumes:
      - ./backend-server/fastapi/app:/app/app:ro
      - ./backend-server/fastapi/vision_task:/app/vision_task:ro
      - ./backend-server/fastapi/faiss_store:/app/faiss_store:ro
      - ./backend-server/fastapi/.env:/app/.env:ro
    environment:
      - FAISS_ALLOW_DANGEROUS_DESERIALIZATION=true
      - LANGCHAIN_ALLOW_DANGEROUS_DESERIALIZATION=true
      - HF_MODEL_NAME=${HF_MODEL_NAME:-00PJH/Llama-3.2-Korean-GGACHI-1B-Instruct-v1-koToEn}
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=root
      - DB_NAME=recipe_db
      - SSH_ROOT_PASSWORD=${SSH_ROOT_PASSWORD:-root123}
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cookduck-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # FastAPI GateAPI 서버 (WebSocket 음성 채팅)
  fastapi-gateapi:
    build:
      context: ./backend-server/fastapi
      dockerfile: Dockerfile.gateapi
    platform: linux/arm64
    container_name: cookduck-fastapi-gateapi
    ports:
      - "${FASTAPI_GATEAPI_PORT:-8003}:8000"
      - "${FASTAPI_GATEAPI_SSH_PORT:-2203}:22"
    volumes:
      - ./backend-server/fastapi/fastapi_gateapi:/app/fastapi_gateapi:ro
      - gateapi-tmp:/tmp
      - gateapi-tts-cache:/app/fastapi_gateapi/tts_cache
      - ./backend-server/fastapi/.env:/app/.env:ro
    environment:
      - AI_SERVER_URL=http://host.docker.internal:8001
      - AI_SERVER_LLM_URL=http://host.docker.internal:8001
      - AI_SERVER_TTS_URL=http://host.docker.internal:8002
      - SSH_ROOT_PASSWORD=${SSH_ROOT_PASSWORD:-root123}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - cookduck-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Vision FastAPI 서버 (YOLO 기반 식재료 인식)
  vision:
    build:
      context: ./backend-server/vision-edit_fastapi
      dockerfile: Dockerfile
    platform: linux/arm64
    container_name: cookduck-vision
    ports:
      - "8000:8000"
    volumes:
      - ./backend-server/vision-edit_fastapi/app:/app/app:ro
      - ./backend-server/vision-edit_fastapi/service:/app/service:ro
      - ./backend-server/fastapi/faiss_store:/app/faiss_store:ro
      - ./backend-server/fastapi/.env:/app/.env:ro
      - ./backend-server/vision-edit_fastapi/.env:/app/.env:ro
    environment:
      - INGREDIENT_MODEL_PATH=/app/service/model/veg_yolov8.pt
      - SSH_ROOT_PASSWORD=${SSH_ROOT_PASSWORD:-root123}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_VLM_MODEL=${OPENAI_VLM_MODEL:-gpt-4o-mini}
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cookduck-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/fastapi/vision/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Spring Boot 서버
  spring:
    build:
      context: ./backend-server/spring
      dockerfile: Dockerfile
    platform: linux/arm64
    container_name: cookduck-spring
    ports:
      - "${SPRING_PORT:-8080}:8080"
      - "${SPRING_SSH_PORT:-2204}:22"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/recipe_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.MariaDBDialect
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - SSH_ROOT_PASSWORD=${SSH_ROOT_PASSWORD:-root123}
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cookduck-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # MariaDB 데이터베이스
  mariadb:
    image: mariadb:10.6
    platform: linux/arm64
    container_name: cookduck-mariadb
    ports:
      - "${MARIADB_PORT:-3307}:3306"
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD:-root}
      - MARIADB_DATABASE=${MARIADB_DATABASE:-recipe_db}
      - MARIADB_USER=${MARIADB_USER:-}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD:-}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./backend-server/fastapi/add_ingredient_columns.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    networks:
      - cookduck-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MARIADB_ROOT_PASSWORD:-root}"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

volumes:
  mariadb_data:
    driver: local
  gateapi-tmp:
    driver: local
  gateapi-tts-cache:
    driver: local

networks:
  cookduck-network:
    driver: bridge
